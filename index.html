<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa con iconos personalizados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; width: 100%; }

  #sidebar {
    position: absolute;
    top: 0;
    right: 0;
    width: 300px;
    height: 100vh;
    background: white;
    border-left: 2px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
    word-wrap: break-word;
    display: none;
    z-index: 2000; /* siempre adelante */
  }

  .leaflet-control-geosearch {
    transform-origin: top center;
    z-index: 1001; /* debajo del panel */
  }

  /* Botón de geolocalización */
  .leaflet-control-locate {
    position: absolute;
    right: 20px;
    z-index: 1500;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geosearch/dist/geosearch.umd.js"></script>
<script>
  // 🔹 Variables configurables
  const tamanioIcono = 7; // % pantalla para iconos
  const tamanioBuscador = 7; // % pantalla para buscador
  const tamanioGeolocalizador = 8; // % pantalla para geolocalizador
  const margenGeolocalizador = 9; // % altura de pantalla adicional para móviles

  // Inicializar mapa sin zoom
  var map = L.map('map', { zoomControl: false }).setView([-34.6037, -58.3816], 13);
  var sidebar = document.getElementById("sidebar");
  var panelAbierto = false;

  // Capa base
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Función para calcular tamaño icono
  function calcularIcono(sizePercent) {
    const size = Math.min(window.innerWidth, window.innerHeight) * (sizePercent/100);
    return [size, size * 1.3];
  }

  // Cargar marcadores desde JSON
  fetch("puntos.json")
    .then(response => response.json())
    .then(puntos => {
      puntos.forEach(p => {
        const [iconWidth, iconHeight] = calcularIcono(tamanioIcono);

        var icon = L.icon({
          iconUrl: p.iconUrl,
          iconSize: [iconWidth, iconHeight],
          iconAnchor: [iconWidth/2, iconHeight],
          popupAnchor: [0, -iconHeight]
        });

        var marker = L.marker([p.lat, p.lng], { icon: icon }).addTo(map);

        marker.on("click", function(e) {
          e.originalEvent.stopPropagation();
          sidebar.style.display = "block";
          sidebar.innerHTML = `<h2>${p.titulo}</h2><p>${p.descripcion}</p>`;
          panelAbierto = true;
        });
      });
    });

  map.on("click", function() {
    if (panelAbierto) {
      sidebar.style.display = "none";
      panelAbierto = false;
    }
  });

  // 🔹 Buscador
  const provider = new window.GeoSearch.OpenStreetMapProvider();
  const searchControl = new window.GeoSearch.GeoSearchControl({
    provider: provider,
    style: 'bar',
    showMarker: true,
    showPopup: false,
    autoClose: true,
    retainZoomLevel: false,
    position: 'topleft',
    marker: { icon: new L.Icon.Default(), draggable: false }
  });
  map.addControl(searchControl);

 function ajustarBuscador() {
  const controls = document.getElementsByClassName('leaflet-control-geosearch');
  const scale = window.innerHeight * (tamanioBuscador/100) / 40;
  for (let c of controls) {
    c.style.right = "auto";        // eliminar posicionamiento derecho
    c.style.left = "50%";          // centrar horizontal
    c.style.transform = `translateX(-50%) scale(${scale})`; // centrar y escalar
  }
}
  ajustarBuscador();
  window.addEventListener('resize', ajustarBuscador);

  map.on('geosearch/showlocation', function(result) {
    const centro = result.location;
    map.setView([centro.y, centro.x], 14);
    sidebar.style.display = "none";
    panelAbierto = false;
  });

  // 🔹 Botón geolocalización
  const locateControl = L.control({position: 'bottomright'});
  locateControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-control-locate');
    div.style.backgroundImage = 'url(https://raw.githubusercontent.com/jeanlucaspl/mapa_delito/2e2a29bee84f2c3e345b45350f5475ed2f0b8cf0/geolocalizacion.png)';
    div.style.backgroundSize = 'contain';
    div.style.backgroundRepeat = 'no-repeat';
    div.style.backgroundPosition = 'center';
    div.title = 'Ir a mi ubicación';
    div.onclick = function() {
      map.locate({setView: true, maxZoom: 16});
    };
    return div;
  };
  locateControl.addTo(map);

  function ajustarLocate() {
    const size = window.innerHeight * (tamanioGeolocalizador/100);
    let bottomOffset = 20; // default
    // detectar dispositivos móviles/tablets
    if (/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent)) {
      bottomOffset = window.innerHeight * (margenGeolocalizador/100);
    }
    const btns = document.getElementsByClassName('leaflet-control-locate');
    for (let b of btns) {
      b.style.width = size + 'px';
      b.style.height = size + 'px';
      b.style.bottom = bottomOffset + 'px';
    }
  }
  ajustarLocate();
  window.addEventListener('resize', ajustarLocate);

  map.on('locationfound', function(e) {
    L.marker(e.latlng).addTo(map)
      .bindPopup("Usted está aquí").openPopup();
  });
  map.on('locationerror', function(e) {
    alert("No se pudo obtener la ubicación: " + e.message);
  });

</script>
</body>
</html>
