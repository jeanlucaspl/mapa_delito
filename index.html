<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa con iconos personalizados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; width: 100%; }

  #sidebar {
    position: absolute;
    top: 0;
    right: 0;
    width: 300px;
    height: 100vh;
    background: white;
    border-left: 2px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
    word-wrap: break-word;
    display: none;
    z-index: 2000; /* siempre adelante */
  }

  .leaflet-control-geosearch {
    position: absolute !important;
    top: 10px;
    left: 50% !important; 
    transform: translateX(-50%) scale(1);
    z-index: 1001;
  }

  /* Controles personalizados */
  .leaflet-control-custom {
    position: absolute;
    z-index: 1500;
    cursor: pointer;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geosearch/dist/geosearch.umd.js"></script>
<script>
  // 🔹 Variables configurables
  const tamanioIcono = 7; // % pantalla para iconos de reportes y talleres
  const tamanioBuscador = 7; // % pantalla para buscador
  const tamanioGeolocalizador = 8; // % pantalla geolocalizador
  const tamanioWhatsapp = 8; // % pantalla whatsapp
  const margenInferior = 5; // % altura para mover botones en móviles

  // Inicializar mapa sin zoom
  var map = L.map('map', { zoomControl: false }).setView([-34.6037, -58.3816], 13);
  var sidebar = document.getElementById("sidebar");
  var panelAbierto = false;

  // Capa base
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Función para calcular tamaño icono
  function calcularIcono(sizePercent) {
    const size = Math.min(window.innerWidth, window.innerHeight) * (sizePercent/100);
    return [size, size * 1.3];
  }

  // 🔹 Cargar marcadores de reportes (puntos.json)
  fetch("puntos.json")
    .then(response => response.json())
    .then(puntos => {
      puntos.forEach(p => {
        const [iconWidth, iconHeight] = calcularIcono(tamanioIcono);

        var icon = L.icon({
          iconUrl: p.iconUrl,
          iconSize: [iconWidth, iconHeight],
          iconAnchor: [iconWidth/2, iconHeight],
          popupAnchor: [0, -iconHeight]
        });

        var marker = L.marker([p.lat, p.lng], { icon: icon }).addTo(map);

        marker.on("click", function(e) {
          e.originalEvent.stopPropagation();
          sidebar.style.display = "block";
          sidebar.innerHTML = `<h2>${p.titulo}</h2><p>${p.descripcion}</p>`;
          panelAbierto = true;
        });
      });
    });

  // 🔹 Cargar marcadores de talleres (spots.json)
  fetch("spots.json")
    .then(response => response.json())
    .then(spots => {
      spots.forEach(s => {
        const [iconWidth, iconHeight] = calcularIcono(tamanioIcono);

        var icon = L.icon({
          iconUrl: s.iconUrl,
          iconSize: [iconWidth, iconHeight],
          iconAnchor: [iconWidth/2, iconHeight],
          popupAnchor: [0, -iconHeight]
        });

        var marker = L.marker([s.lat, s.lng], { icon: icon }).addTo(map);

        marker.on("click", function(e) {
          e.originalEvent.stopPropagation();
          sidebar.style.display = "block";
          sidebar.innerHTML = `<h2>${s.titulo}</h2><p>${s.descripcion}</p>`;
          panelAbierto = true;
        });
      });
    });

  map.on("click", function() {
    if (panelAbierto) {
      sidebar.style.display = "none";
      panelAbierto = false;
    }
  });

  // 🔹 Buscador
  const provider = new window.GeoSearch.OpenStreetMapProvider();
  const searchControl = new window.GeoSearch.GeoSearchControl({
    provider: provider,
    style: 'bar',
    showMarker: true,
    showPopup: false,
    autoClose: true,
    retainZoomLevel: false,
    position: 'topleft',
    marker: { icon: new L.Icon.Default(), draggable: false }
  });
  map.addControl(searchControl);

  function ajustarBuscador() {
    const controls = document.getElementsByClassName('leaflet-control-geosearch');
    const scale = window.innerHeight * (tamanioBuscador/100) / 40;
    for (let c of controls) {
      c.style.transform = `translateX(-50%) scale(${scale})`;
    }
  }
  ajustarBuscador();
  window.addEventListener('resize', ajustarBuscador);

  map.on('geosearch/showlocation', function(result) {
    const centro = result.location;
    map.setView([centro.y, centro.x], 14);
    sidebar.style.display = "none";
    panelAbierto = false;
  });

  // 🔹 Botón geolocalización (derecha extrema)
  const locateControl = L.control({position: 'bottomright'});
  locateControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-control-custom');
    div.style.backgroundImage = 'url(https://raw.githubusercontent.com/jeanlucaspl/mapa_delito/main/geolocalizacion.png)';
    div.title = 'Ir a mi ubicación';
    div.style.right = "10px"; // pegado a la derecha
    div.onclick = function() {
      map.locate({setView: true, maxZoom: 16});
    };
    return div;
  };
  locateControl.addTo(map);

  // 🔹 Botón WhatsApp (izquierda extrema)
  const whatsappControl = L.control({position: 'bottomleft'});
  whatsappControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-control-custom');
    div.style.backgroundImage = 'url(https://raw.githubusercontent.com/jeanlucaspl/mapa_delito/main/whatsapp.png)';
    div.title = 'Contactar por WhatsApp';
    div.style.left = "10px"; // pegado a la izquierda
    div.onclick = function() {
      window.open('https://wa.me/5491138543743?text=Quiero%20reportar%20un%20hecho', '_blank');
    };
    return div;
  };
  whatsappControl.addTo(map);

  // 🔹 Ajustar tamaños/márgenes
  function ajustarControles() {
    const sizeGeo = window.innerHeight * (tamanioGeolocalizador/100);
    const sizeWsp = window.innerHeight * (tamanioWhatsapp/100);
    let bottomOffset = 20;
    if (/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent)) {
      bottomOffset = window.innerHeight * (margenInferior/100);
    }
    const geoBtn = document.querySelector('.leaflet-bottom.leaflet-right .leaflet-control-custom');
    if (geoBtn) {
      geoBtn.style.width = sizeGeo + 'px';
      geoBtn.style.height = sizeGeo + 'px';
      geoBtn.style.bottom = bottomOffset + 'px';
      geoBtn.style.right = "10px"; // asegura que quede a la derecha
    }
    const wspBtn = document.querySelector('.leaflet-bottom.leaflet-left .leaflet-control-custom');
    if (wspBtn) {
      wspBtn.style.width = sizeWsp + 'px';
      wspBtn.style.height = sizeWsp + 'px';
      wspBtn.style.bottom = bottomOffset + 'px';
      wspBtn.style.left = "10px"; // asegura que quede a la izquierda
    }
  }
  ajustarControles();
  window.addEventListener('resize', ajustarControles);

  // 🔹 Eventos ubicación
  map.on('locationfound', function(e) {
    L.marker(e.latlng).addTo(map)
      .bindPopup("Usted está aquí").openPopup();
  });
  map.on('locationerror', function(e) {
    alert("No se pudo obtener la ubicación: " + e.message);
  });
</script>
</body>
</html>
